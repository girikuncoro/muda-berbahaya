<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Mata Garuda</title>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.1/css/selectize.bootstrap3.min.css">

  <style>
    .popover {
      outline: none;
      -webkit-box-shadow: none !important;
      -moz-box-shadow: none !important;
      box-shadow: none !important;
      box-radius: 1px;
    }

    .popover-title {
      padding: 8px;
      font-size: 11px;
    }

    .popover-content {
      padding: 8px;
      font-size: 11px;
    }

    .reduce-space {
      margin-bottom: 4px;
    }

    .bar {
      fill: steelblue;
    }

    .arrow {
      display:none !important;
    }

    .arc text {
      font-size: 10px;
    }
  </style>
</head>
<body>

<div class="container" style="padding-top:20px;">

  <div class="row">
<!--     <div class="col-md-4">
      <label for="select-province" class="sr-only">Provinces</label>
      <select id="select-province" placeholder="Select a province...">
        <option value="">Select a province...</option>
      </select>
    </div> -->

    <div class="col-md-4">
      <label for="select-problem" class="sr-only">Problems</label>
      <select id="select-problem" placeholder="Select type of problem...">
        <option value="">Select type of problem...</option>
      </select>
    </div>

<!--     <div class="col-md-4">
      <label for="select-fear" class="sr-only">Fears</label>
      <select id="select-fear" placeholder="Select type of fear...">
        <option value="">Select type of fear...</option>
      </select>
    </div> -->
  </div>

  <div class="map"></div>
  
</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.1/js/standalone/selectize.min.js"></script>

<script>
var width = 960,
  height = 400;

var svg = d3.select(".map").append("svg")
  .attr("width", width)
  .attr("height", height);

var colors = d3.scale.linear()
      .range(["#e0f3db","#a8ddb5","#43a2ca"]),
    colorPie = d3.scale.ordinal()
      .range(["#8856a7", "#9ebcda"]),
    colorDuration = d3.scale.ordinal()
      .range(["#88419d", "#8c96c6",  "#b3cde3", "#edf8fb"  ]);

var projection = d3.geo.albers()
  .center([0, -3.175])
  .rotate([-118.8283, 0])
  //.rotate([-106.8283, 0])
  .parallels([-2, 0])
  .scale(1100)
  .translate([width / 2, height / 2]);

var path = d3.geo.path()
  .projection(projection);

queue()
  .defer(d3.tsv, 'muda.tsv')
  .defer(d3.json, 'idn.json')
  .await(init);

var selectedProvince = null;

var tempcolor,
    tempdata;

function init(error, muda, idn) {
  var provData = {};

  var provinces = d3.nest()
    .key(function(d) { return d.origin; }).sortKeys(d3.ascending)
    .map(muda);

  _.each(provinces, function(province, keys) {
    // Rename province defined in TopoJSON
    // keys = renameProvince(keys);

    var optimistic = _.countBy(province, function(p) {
      return p.optimistic;
    });

    var eastdev = _.countBy(province, function(p) {
      return p.eastdev;
    });

    var duration = _.countBy(province, function(p) {
      return p.duration;
    });

    var optimistic = { "Yes":0, "Maybe":0, "No":0 },
        eastdev = { "Yes":0, "No":0 },
        duration = { "< 2":0, "2-5":0, "5-7":0, "> 7":0 },
        fears = {},
        problems = {};

    _.each(province, function(d) {
      d.fear = d.fear.replace(/ /g,'').toLowerCase().split(",");
      d.problem = d.problem.replace(/ /g,'').toLowerCase().split(",");
      
      d.fear.forEach(function(e) {
        if(e != "") fears[e] = fears[e] + 1 || 1;
      });
      
      d.problem.forEach(function(e) {
        if(e != "") problems[e] = problems[e] + 1 || 1;
      });

      optimistic[d.optimistic] = optimistic[d.optimistic] + 1;
      eastdev[d.eastdev] = eastdev[d.eastdev] + 1;
      if(d.duration != "") duration[d.duration] = duration[d.duration] + 1;

    });

    var total = optimistic["Yes"] + optimistic["Maybe"] + optimistic["No"];

    var optimisticYes = optimistic["Yes"] / total * 100;
    
    var optimisticNo = 100 - optimisticYes;

    provData[keys] = {'name':keys, 'opstat': optimistic, 'optimistic': optimisticYes, 'pessimistic': optimisticNo, 'eastdev': eastdev, 'duration': duration, 'fear': fears, 'problem': problems };

    provData[keys].opstat['Total'] = total;
  });

  var sum = sumProvince(provData);

  var maps = topojson.feature(idn, idn.objects.provinces).features;

  _.each(maps, function(d) {
    var name = d.properties.name;
    // Rename province defined in topoJSON data
    d.stat = provData[renameProvince(name)];
  });

  maps = _.filter(maps, function(d) { return d.properties.name != null; });

  drawMap(maps, 'optimistic');

  populateSelection(sum);
}

function drawMap(data, param) {
  // Polylinear color scale
  colors.domain([
    d3.min(data, function(d) { return d.stat[param]; }),
    d3.median(data, function(d) { return d.stat[param]; }),
    d3.max(data, function(d) { return d.stat[param]; })]);

  svg.selectAll("append")
    .data(data)
    .enter().append("path")
    .attr("d", path)
    .attr("id", function(d) { return d.stat.name.replace(/ /g,'').toLowerCase(); })
    .style("fill", function(d) { return colors(d.stat[param]); })
    .style("stroke", "#fff")
    .style("stroke-width", .5)
    .on("mouseover", function(d){
      d3.select(this).style("fill", "#e6550d");
      showPopover.call(this,d);
      makeBarchart(d.stat);
    })
    .on("mouseout", function(d){
      d3.select(this).style("fill", function(d) { return $(this).attr("id") == selectedProvince ? "#e6550d" : colors(d.stat[param]); });
      removePopover();
    })
    .on("click", function(d) { 
      // showPopover.call(this,d);
      // makeBarchart(d.stat);
      var prov = d.stat.name.replace(/ /g,'').toLowerCase();

      console.log(d.stat); 
      if(selectedProvince != '') d3.select("#"+selectedProvince).style("fill", colors(tempdata));

      tempdata = d.stat[param];
      selectedProvince = prov;
      showDetails(d.stat);
      // removeDetails();
    });

}

function showDetails(data) {  
  console.log(data);

  svg.datum(data);

  if($(".overlay").length) {
    svg.selectAll("rect.overlay").remove();

    $("div.overlay").hide();

    svg.append("rect")
      .attr("class", "overlay")
      .attr("width", width/3)
      .attr("height", height)
      // .attr("y", 15)
      .attr("x", width*2/3)
      .style("fill", "#FFF")
     .transition().duration(300)
      .attr("width", 0)
      .attr("height", height)
      // .attr("y", 15)
      .attr("x", width)
      .style("fill", "#FFF")
     .transition().duration(500)
      .attr("width", width/3)
      .attr("height", height)
      // .attr("y", 15)
      .attr("x", width*2/3)
      .style("fill", "#FFF")
      .each("end", function() {
        $("div.overlay").show();
        populateDetails(data);
      });
    
  } else {

    svg.append("rect")
      .attr("class", "overlay")
      .attr("width", 0)
      .attr("x", width)
      .style("fill", "#FFF")
     .transition().duration(500)
      .attr("width", width/3)
      .attr("height", height)
      // .attr("y", 15)
      .attr("x", width*2/3)
      .style("fill", "#FFF")
      .each("end", function() {
        svg.append("foreignObject")
          .attr("class", "overlay")
          .attr("width", width/3)
          .attr("height", height/2)
          // .attr("y", 15)
          .attr("x", width*2/3)
         .append("xhtml:div")
          .html(function(d) { return "<div class='overlay'></div>" })
          .style("width", width/3)
          .style("height", "385px")
          .style("overflow-y", "scroll");

          populateDetails(data);
      });
  }    
}

function populateDetails(data) {
  var detail = 
  "<div class='page-header'>" +
    "<h3 class='text-center'>" + data.name + "</h3>" +
    "<p class='text-center reduce-space'><b>" + data.opstat["Yes"] + "</b> of <b>" + data.opstat["Total"] + "</b> youth optimistic in Indonesia's future</p>" +
  "</div>" +
    
  "<div class='detail-pie'></div>" + 
  "<div class='detail-bar'></div>" ;

  $("div.overlay").empty();
  $("div.overlay").append(detail);

  // console.log(d.problem);
  var rural = _.map(data.eastdev, function(v,k) { return {key:k, value:v} });

  var duration = _.map(data.duration, function(v,k) { return {key:k, value:v} });

  var w = width/6,
      h = 155,
      r = Math.min(w,h) / 2;

  var arc = d3.svg.arc()
    .outerRadius(r - 25)
    .innerRadius(r - 45);

  var pie = d3.layout.pie()
    .sort(null)
    .value(function(d) { return d.value; });

  var svg = d3.select("div.detail-pie").append("svg")
    .attr("width", w)
    .attr("height", h)
   .append("g")
    .attr("transform", "translate(" + w/2 + "," + h/2.5 + ")");

  var svg1 = d3.select("div.detail-pie").append("svg")
    .attr("width", w)
    .attr("height", h)
   .append("g")
    .attr("transform", "translate(" + w/2 + "," + h/2.5 + ")");

  var g = svg.selectAll(".arc")
    .data(pie(rural))
   .enter().append("g")
    .attr("class", "arc");

  g.append("path")
    .attr("d", arc)
    .style("fill", function(d) { return colorPie(d.data.key) });

  g.append("text")
    .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")" })
    .attr("dy", ".35em")
    .style("text-anchor", "middle")
    .text(function(d) { if(d.data.value != 0) return d.data.key; });

  g.append("text")
    .attr("dy", ".35em")
    .style("text-anchor", "middle")
    .style("font-size", "20px")
    .text(function() { return (data.eastdev["Yes"] * 100 / (data.eastdev["Yes"] + data.eastdev["No"])).toFixed(0) + "%";  });

  g.append("text")
    .attr("y",h/2)
    .attr("dy", "-1.25em")
    .style("text-anchor", "middle")
    .text("Willing to develop");

  g.append("text")
    .attr("y",h/2)
    .attr("dy", "-.2em")
    .style("text-anchor", "middle")
    .text("East Indonesia?");

  var g1 = svg1.selectAll(".arc")
    .data(pie(duration))
   .enter().append("g")
    .attr("class", "arc");

  g1.append("path")
    .attr("d", arc)
    .style("fill", function(d) { return colorDuration(d.data.key) });

  g1.append("text")
    .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")" })
    .attr("dy", ".35em")
    .style("text-anchor", "middle")
    .text(function(d) { if(d.data.value != 0) return d.data.key; });

  g1.append("text")
    .attr("dy", ".35em")
    .style("text-anchor", "middle")
    .style("font-size", "20px")
    .text(function() { 
      var total = data.duration["< 2"] + data.duration["2-5"]+ data.duration["5-7"] + data.duration["> 7"];
      var avg = (data.duration["< 2"] * 1 + data.duration["2-5"] * 3 + data.duration["5-7"] * 6 + data.duration["> 7"] * 8)/total;

      if(avg > 7) { return "7+" }
      else { return avg.toFixed(1); }
  });

  g1.append("text")
    .attr("dy", "1.45em")
    .style("text-anchor", "middle")
    .text("years");

  g1.append("text")
    .attr("y",h/2)
    .attr("dy", "-1.25em")
    .style("text-anchor", "middle")
    .text("How many years are you");

  g1.append("text")
    .attr("y",h/2)
    .attr("dy", "-.2em")
    .style("text-anchor", "middle")
    .text("willing to stay here?");
}

function showPopover(data) {
  var selection = this,
      province = renameProvince(data.properties.name),
      left = ["Papua", "Papua Barat"];

  $(selection).popover({
    title: province,
    placement: 'auto right',
    container: 'body',
    html: true,
    // content: function() {
    //   // var pop = "<div><p class='reduce-space'><b>Optimist:</b> " + data.stat.optimistic.toFixed(0) + " %</p>"
    //   //           + "<p class='reduce-space'><b>Pessimist:</b> " + data.stat.pessimistic.toFixed(0) + " %</p></div>";

    //   var pop = "<div class='canvas'>" +  + "</div>";

    //   return pop;
    // }
  });

  $(selection).popover('show');
}

function removePopover() {
  $(".popover").each(function() {
    $(this).remove();
  })
}

function makeBarchart(data) {
  var stat = [{key:"Optimist", value:data.optimistic}, 
              {key:"Pessimist", value:data.pessimistic}];

  var w = 150,
      m = { left: 30, right:45 },
      barH = 20;

  var x = d3.scale.linear()
    .domain([0,100])
    .range([0,w]);

  var svg = d3.select(".popover-content").append("svg")
    .attr("width",w + m.left + m.right)
    .attr("height",barH * stat.length)
   .append("g")
    .attr("transform", "translate(" + m.left + ", 0)");

  var bar = svg.selectAll(".bar")
    .data(stat)
   .enter().append("g")
    .attr("transform", function(d,i) { return "translate(0," + i * barH + ")" })

  bar.append("rect")
    .attr("class", "bar")
    .attr("width", function(d) { return x(d.value); })
    .attr("height", barH - 1);

  bar.append("text")
    .attr("x", 0)
    .attr("dx", "-.15em")
    .attr("y", barH/2)
    .attr("dy", ".35em")
    .style("text-anchor", "end")
    .text(function(d) { return d.value.toFixed(0) + "%"; });

  bar.append("text")
    .attr("x", function(d) { return x(d.value); })
    .attr("dx", ".15em")
    .attr("y", barH/2)
    .attr("dy", ".35em")
    .style("text-anchor", "start")
    .text(function(d) { return d.key; });
}

function sumProvince(data) {
  var problems = {},
      fears = {};

  _.each(data, function(d) {
    _.each(d.problem, function(v,k) {
      problems[k] = problems[k] + v || v;
    })

    _.each(d.fear, function(v,k) {
      fears[k] = fears[k] + v || v;
    })
  });

  return {'problems':problems, 'fears':fears, 'provinces':_.allKeys(data)};
}

function populateSelection(data) {
  console.log(data);

  // var provinceList = _.map(data.provinces, function(d) { return {text: d, value: d} });

  var problemList = _.map(data.problems, function(v,k) { return {text: renameProblems(k), value: k} });

  // var fearList = _.map(data.fears, function(v,k) { return {text: k, value: k} });

  // $("#select-province").selectize({
  //   plugins: ['remove_button'],
  //   persist: true,
  //   sortField: 'text',
  //   maxItems: '1',
  //   onChange: function(prov) {
  //     if(selectedProvince != null || selectedProvince != '') {
  //       d3.select("#"+selectedProvince).style("fill", tempcolor);
  //     }

  //     if(prov != '') {
  //       selectedProvince = prov.replace(/ /g,'').toLowerCase(); 
  //       tempcolor = d3.select("#"+selectedProvince).style("fill");
  //       d3.select("#"+selectedProvince).style("fill", "#e6550d");   
  //     }
    
  //   }
  // });

  $("#select-problem").selectize({
    plugins: ['remove_button'],
    persist: true,
    sortField: 'text',
    maxItems: 3,
  }); 

  // $("#select-fear").selectize({
  //   plugins: ['remove_button'],
  //   persist: true,
  //   sortField: 'text',
  //   maxItems: 3,
  // }); 

  // var selectize = $("#select-province")[0].selectize;
  // selectize.load(function(callback) {
  //   callback(provinceList);
  // });

  var selectize1 = $("#select-problem")[0].selectize;
  selectize1.load(function(callback) {
    callback(problemList);
  });

  // var selectize2 = $("#select-fear")[0].selectize;
  // selectize2.load(function(callback) {
  //   callback(fearList);
  // });

}

function renameProvince(name) {
  switch(name) {
    case 'Riau':
      name = 'Riau (Daratan)';
      break;
    case 'Bangka-Belitung':
      name = 'Bangka Belitung';
      break;
    case 'Jakarta Raya':
      name = 'DKI Jakarta';
      break;
    case 'Yogyakarta':
      name = 'DI Yogyakarta';
      break;
    case 'Irian Jaya Barat':
      name = 'Papua Barat';
      break;
  }
  return name;
}

function renameProblems(problem) {
  switch(problem) {
    case 'creativetourism':
      problem = 'Tourism & Creative Economy';
      break;
    case 'politicslaw':
      problem = 'Law & Politics';
      break;
    case 'genderequality':
      problem = 'Gender Equality';
      break;
    case 'humansociety':
      problem = 'Human & Society';
      break;
    case 'naturalresources':
      problem = 'Natural Resources';
      break;
    case 'limitedjob':
      problem = 'Limited Jobs';
      break;
  }
  return problem.substr(0,1).toUpperCase() + problem.substr(1);;

    // if(k == "creativetourism") { k = "Tourism & Creative Economy"; }
  // else if(k == "politicslaw") { k = "Law & Politics"; }
  // else if(k == "genderequality") { k = "Gender Equality"; }
  // else if(k == "humansociety") { k = "Human & Society"; }
  // else if(k == "naturalresources") { k = "Natural Resources"; }
  // else if(k == "limitedjob") { k = "Limited Jobs"; }

  // k = k.substr(0,1).toUpperCase() + k.substr(1);  
}

</script>
</body>
</html>